# React

> 是由 Facebook 研发到的，严格来说不是框架，而是用于解决 UI 复杂的开源的 js 库，目前由 React 社区联合维护。

## 渲染原理

_如果要得到真实的 DOM 元素身上的属性，那么必须等到 componentDidMount 函数运行后_

> 渲染：生成用于显示的对象，以及将这些对象形成真实的 DOM 对象

> 为了更好的优化渲染，React 会构建虚拟的 DOM 树，在合适的时候显示到页面中

- React 元素：通过 React.createElement 创建（语法糖：JSX）

- React 根据不同的元素类型，生成不同的 React 节点

### 首次渲染（新节点生成）

> 节点：专门用于渲染到 UI 的对象

1. DOM 节点：生成对应的虚拟 DOM 节点，如果有 children 属性，遍历 children 数组中的内容

2. 组件节点：分为函数组件和类组件节点

- 函数组件：

根据 return 的返回值，当作节点进行渲染

- 类组件：

1）创建该类的实例

2）调用静态属性（生命周期函数 React >= 16.0.0） getDerivedStateFromProps

3）执行 render 函数，根据 return 的返回值，进行遍历，然后当作节点进行渲染

4）React 会将 componentDidMount 中的函数压入到执行队列中，这个时间点是在 render 执行完后（遍历完），遵循的原则是：先进先出（先进先执行）

3. 文本节点：普通的字符串、数字，通过 document.createTextNode 创建真实的文本节点

4. 空节点：null、false、undefined、true，不会做任何操作，只是起占位的作用

5. 数组节点：遍历数组中的每一项，根据不同的节点类型，做出对应的创建

> 经历上述过程后，虚拟的 DOM 树构建完成

### 更新

> React 比较虚拟 DOM 树的时候，采用的是 diff 算法

1. React 默认虚拟 DOM 树中的元素层级不会发生改变

2. React 会根据节点类型是否相同（如果是 React 元素，那么 type 值也必须相同），做出相应的判断

3. 多兄弟节点的时候，要加上 key 值，作用是：比较对应的 React 节点（同一层级中）

- 类似于 vue 的 “就近原则”，React 会将真实的 DOM 元素复用

- 当处理的数组的时候，一定要加上 key（唯一标识），提高渲染效率

1）通过 ReactDOM.render()，该函数会导致整个 React 虚拟 DOM 树重新构建，重新转为真实的 DOM 树，渲染到页面中

2）在类组件中，调用了 this.setState()，该函数会改变该组件中的状态，导致该组件以及它的子组件重新渲染

1. DOM 节点；会重用之前渲染好的真实的 DOM 元素

2. 文本节点：会执行 nodeValue 方法

3. 数组节点：遍历该数组，将每一项的值依次与节点类型比较

4. 空节点：不做任何处理，只起占位的作用

5. 函数组件节点：直接调用执行，将 return 的返回值当作节点渲染

6. 类组件节点：

- 重用该类的实例对象

- 调用静态属性（生命周期函数 React >= 16.0.0）getDerivedStateFromProps

- 调用 shouldComponentUpdate 方法，如果返回 false，终止该过程

- 调用 render 函数，根据 return 的返回值，进行遍历，然后当作节点进行渲染

- 调用 getSnapshotBeforeUpdate 函数，并将其压入执行队列中，等待执行

- 将 componentDidUpdate 函数压入到执行队列中，这个时间点是在 render 执行完（遍历完）后，遵循的原则是：先进先出（先进先执行）

- 如果销毁了该组件，会立即调用该组件的 componentWillUnmount 方法

> 经历上述过程，虚拟的 DOM 树更新完毕

3）将真实的 DOM 树渲染到页面中

4）依次执行队列中的 componentDidMount 函数

5）依次执行队列中的 getSnapshotBeforeUpdate 函数

6）依次执行队列中的 componentDidUpdate 函数

### 卸载

> React 采取的方式是：根据层级关系，依次比较虚拟 DOM 树，当其发现有不一样的时候，会进行对应的抉择：

1. 匹配上了对应的 React 节点：根据上述的更新步骤，如果发现其发生了变化：

1）函数组件节点、文本节点、数组节点、空节点、DOM 节点，直接抛弃，并对其递归子组件，依次抛弃

2）类组件，直接调用该组件的 componentWillUNmount 函数，然后抛弃该组件，并依次递归其子组件，依次抛弃

2. 没有匹配上对应的 React 节点：直接抛弃

_当 React 处理的时候，会先进行 React 节点的创建，经历首次渲染的过程，再抛弃旧的 React 节点，最后才会将对应的虚拟 DOM 树进行更新_
